name: Publish to Homebrew

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string
      dry_run:
        description: 'Run in dry-run mode (skip actual publish)'
        required: false
        type: boolean
        default: true

env:
  TAP_REPO: iii-hq/homebrew-tap
  FORMULA_PATH: Formula/iii-console.rb
  BINARY_REPO: iii-hq/console
  BIN_NAME: iii-console

jobs:
  publish-homebrew:
    name: Update Homebrew Formula
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - name: Validate version format
        env:
          VERSION: ${{ inputs.version }}
        run: |
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format. Expected: v1.2.3"
            exit 1
          fi

          echo "Version validated: $VERSION"

      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.III_CI_APP_ID }}
          private-key: ${{ secrets.III_CI_APP_PRIVATE_KEY }}
          repositories: homebrew-tap

      - name: Checkout tap repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ steps.generate_token.outputs.token }}
          path: homebrew-tap

      - name: Download release assets
        env:
          VERSION: ${{ inputs.version }}
          BINARY_REPO_NAME: ${{ env.BINARY_REPO }}
        run: |
          curl -L --fail -o iii-console-x86_64-apple-darwin.tar.gz \
            "https://github.com/${BINARY_REPO_NAME}/releases/download/${VERSION}/iii-console-x86_64-apple-darwin.tar.gz"

          curl -L --fail -o iii-console-aarch64-apple-darwin.tar.gz \
            "https://github.com/${BINARY_REPO_NAME}/releases/download/${VERSION}/iii-console-aarch64-apple-darwin.tar.gz"

          curl -L --fail -o iii-console-x86_64-unknown-linux-gnu.tar.gz \
            "https://github.com/${BINARY_REPO_NAME}/releases/download/${VERSION}/iii-console-x86_64-unknown-linux-gnu.tar.gz"

          curl -L --fail -o iii-console-aarch64-unknown-linux-gnu.tar.gz \
            "https://github.com/${BINARY_REPO_NAME}/releases/download/${VERSION}/iii-console-aarch64-unknown-linux-gnu.tar.gz"

          for file in iii-console-x86_64-apple-darwin.tar.gz iii-console-aarch64-apple-darwin.tar.gz iii-console-x86_64-unknown-linux-gnu.tar.gz iii-console-aarch64-unknown-linux-gnu.tar.gz; do
            if [ ! -s "$file" ]; then
              echo "::error::$file is missing or empty"
              exit 1
            fi
          done
          ls -lh *.tar.gz

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          MACOS_X86_SHA=$(shasum -a 256 iii-console-x86_64-apple-darwin.tar.gz | awk '{print $1}')
          MACOS_ARM_SHA=$(shasum -a 256 iii-console-aarch64-apple-darwin.tar.gz | awk '{print $1}')
          LINUX_X86_SHA=$(shasum -a 256 iii-console-x86_64-unknown-linux-gnu.tar.gz | awk '{print $1}')
          LINUX_ARM_SHA=$(shasum -a 256 iii-console-aarch64-unknown-linux-gnu.tar.gz | awk '{print $1}')

          echo "macos_x86_64_sha256=${MACOS_X86_SHA}" >> "$GITHUB_OUTPUT"
          echo "macos_aarch64_sha256=${MACOS_ARM_SHA}" >> "$GITHUB_OUTPUT"
          echo "linux_x86_64_sha256=${LINUX_X86_SHA}" >> "$GITHUB_OUTPUT"
          echo "linux_aarch64_sha256=${LINUX_ARM_SHA}" >> "$GITHUB_OUTPUT"

          echo "Checksums calculated:"
          echo "  macOS x86_64:  ${MACOS_X86_SHA}"
          echo "  macOS aarch64: ${MACOS_ARM_SHA}"
          echo "  Linux x86_64:  ${LINUX_X86_SHA}"
          echo "  Linux aarch64: ${LINUX_ARM_SHA}"

      - name: Update formula
        env:
          RELEASE_VERSION: ${{ inputs.version }}
          MACOS_X86_SHA: ${{ steps.checksums.outputs.macos_x86_64_sha256 }}
          MACOS_ARM_SHA: ${{ steps.checksums.outputs.macos_aarch64_sha256 }}
          LINUX_X86_SHA: ${{ steps.checksums.outputs.linux_x86_64_sha256 }}
          LINUX_ARM_SHA: ${{ steps.checksums.outputs.linux_aarch64_sha256 }}
          FORMULA_FILE: ${{ env.FORMULA_PATH }}
        run: |
          VERSION_NUMBER="${RELEASE_VERSION#v}"

          cd homebrew-tap

          mkdir -p Formula

          cat <<BREWEOF > "$FORMULA_FILE"
          class IiiConsole < Formula
            desc "Developer console for the iii engine"
            homepage "https://github.com/iii-hq/console"
            version "${VERSION_NUMBER}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/iii-hq/console/releases/download/${RELEASE_VERSION}/iii-console-aarch64-apple-darwin.tar.gz"
                sha256 "${MACOS_ARM_SHA}"
              else
                url "https://github.com/iii-hq/console/releases/download/${RELEASE_VERSION}/iii-console-x86_64-apple-darwin.tar.gz"
                sha256 "${MACOS_X86_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/iii-hq/console/releases/download/${RELEASE_VERSION}/iii-console-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${LINUX_ARM_SHA}"
              else
                url "https://github.com/iii-hq/console/releases/download/${RELEASE_VERSION}/iii-console-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${LINUX_X86_SHA}"
              end
            end

            def install
              bin.install "iii-console"
            end

            test do
              system "\#{bin}/iii-console", "--version"
            end
          end
          BREWEOF

          # Strip leading whitespace from generated formula
          sed -i '' 's/^          //' "$FORMULA_FILE"

          echo "Formula updated:"
          cat "$FORMULA_FILE"

      - name: Test formula locally
        env:
          FORMULA_FILE: ${{ env.FORMULA_PATH }}
        run: |
          cd homebrew-tap
          brew audit --new --formula "$FORMULA_FILE" || true
          brew install "./$FORMULA_FILE"
          iii-console --version
          brew uninstall iii-console

      - name: Commit and push changes
        if: inputs.dry_run != true
        env:
          RELEASE_VERSION: ${{ inputs.version }}
          FORMULA_FILE: ${{ env.FORMULA_PATH }}
          MACOS_X86_SHA: ${{ steps.checksums.outputs.macos_x86_64_sha256 }}
          MACOS_ARM_SHA: ${{ steps.checksums.outputs.macos_aarch64_sha256 }}
          LINUX_X86_SHA: ${{ steps.checksums.outputs.linux_x86_64_sha256 }}
          LINUX_ARM_SHA: ${{ steps.checksums.outputs.linux_aarch64_sha256 }}
        run: |
          cd homebrew-tap

          git config user.name "iii-ci[bot]"
          git config user.email "iii-ci[bot]@users.noreply.github.com"

          git add "$FORMULA_FILE"
          git commit -m "chore: update iii-console to ${RELEASE_VERSION}

          Automated update from release workflow.

          Changes:
          - Version: ${RELEASE_VERSION}
          - macOS x86_64 SHA256: ${MACOS_X86_SHA}
          - macOS aarch64 SHA256: ${MACOS_ARM_SHA}
          - Linux x86_64 SHA256: ${LINUX_X86_SHA}
          - Linux aarch64 SHA256: ${LINUX_ARM_SHA}
          "

          git push origin main

          echo "Formula published to homebrew-tap!"

      - name: Dry-run summary
        if: inputs.dry_run == true
        env:
          RELEASE_VERSION: ${{ inputs.version }}
          MACOS_X86_SHA: ${{ steps.checksums.outputs.macos_x86_64_sha256 }}
          MACOS_ARM_SHA: ${{ steps.checksums.outputs.macos_aarch64_sha256 }}
          LINUX_X86_SHA: ${{ steps.checksums.outputs.linux_x86_64_sha256 }}
          LINUX_ARM_SHA: ${{ steps.checksums.outputs.linux_aarch64_sha256 }}
        run: |
          echo "DRY RUN MODE - No changes pushed"
          echo ""
          echo "Formula validated successfully:"
          echo "- Version: ${RELEASE_VERSION}"
          echo "- macOS x86_64 SHA256: ${MACOS_X86_SHA}"
          echo "- macOS aarch64 SHA256: ${MACOS_ARM_SHA}"
          echo "- Linux x86_64 SHA256: ${LINUX_X86_SHA}"
          echo "- Linux aarch64 SHA256: ${LINUX_ARM_SHA}"
          echo ""
          echo "Set dry_run=false to publish for real."

      - name: Notify Slack on success
        if: success() && inputs.dry_run != true
        continue-on-error: true
        uses: slackapi/slack-github-action@485a9d42d3a73031f12ec201c457e2162c45d02d # v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "Homebrew formula updated"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Homebrew Formula Updated* :beer:\n\nVersion: `${{ inputs.version }}`\n\nUsers can now install with:\n```brew tap iii-hq/tap\nbrew install iii-console```"

      - name: Notify Slack on failure
        if: failure()
        continue-on-error: true
        uses: slackapi/slack-github-action@485a9d42d3a73031f12ec201c457e2162c45d02d # v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "Homebrew publish failed"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Homebrew Publish Failed* :x:\n\nVersion: `${{ inputs.version }}`\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
