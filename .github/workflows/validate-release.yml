name: Validate Release

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

jobs:
  validate:
    name: Validate Release Artifacts
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}
      release_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.III_CI_APP_ID }}
          private-key: ${{ secrets.III_CI_APP_PRIVATE_KEY }}

      - name: Get release tag
        id: tag
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # For tag-triggered workflow_run events, head_branch contains the tag
          if [[ ! "$HEAD_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::error::Could not determine release tag from workflow run (got: $HEAD_BRANCH)"
            exit 1
          fi
          echo "tag=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "::notice::Validating release: $HEAD_BRANCH"

      - name: Validate binary artifacts
        id: validate
        env:
          RELEASE_TAG: ${{ steps.tag.outputs.tag }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          TARGETS=(
            "x86_64-apple-darwin"
            "aarch64-apple-darwin"
            "x86_64-unknown-linux-gnu"
            "x86_64-unknown-linux-musl"
            "aarch64-unknown-linux-gnu"
          )

          PASSED=true
          MISSING=()

          echo "Validating release artifacts for $RELEASE_TAG..."

          ASSETS=$(gh release view "$RELEASE_TAG" --repo "$GH_REPO" --json assets --jq '.assets[].name' 2>/dev/null || echo "")

          if [[ -z "$ASSETS" ]]; then
            echo "::error::No assets found for release $RELEASE_TAG"
            echo "passed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found assets:"
          echo "$ASSETS"
          echo "---"

          for TARGET in "${TARGETS[@]}"; do
            BINARY_FOUND=false
            CHECKSUM_FOUND=false

            if echo "$ASSETS" | grep -q "iii-console-${TARGET}"; then
              BINARY_FOUND=true
            fi

            if echo "$ASSETS" | grep -q "iii-console-${TARGET}.*\.sha256"; then
              CHECKSUM_FOUND=true
            fi

            if [[ "$BINARY_FOUND" == "true" && "$CHECKSUM_FOUND" == "true" ]]; then
              echo "::notice::$TARGET: binary and checksum present"
            else
              PASSED=false
              if [[ "$BINARY_FOUND" == "false" ]]; then
                echo "::error::$TARGET: binary MISSING"
                MISSING+=("$TARGET (binary)")
              fi
              if [[ "$CHECKSUM_FOUND" == "false" ]]; then
                echo "::error::$TARGET: checksum MISSING"
                MISSING+=("$TARGET (checksum)")
              fi
            fi
          done

          echo "passed=$PASSED" >> "$GITHUB_OUTPUT"

          if [[ "$PASSED" == "false" ]]; then
            echo "::error::Missing artifacts: ${MISSING[*]}"
          else
            echo "::notice::All 5 platform binaries and checksums validated"
          fi

  notify:
    name: Notify Validation Result
    needs: validate
    if: always() && needs.validate.result != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@485a9d42d3a73031f12ec201c457e2162c45d02d # v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "${{ needs.validate.outputs.validation_passed == 'true' && ':white_check_mark: *iii-console Release Validation Passed*' || ':warning: *iii-console Release Validation Failed*' }}\nVersion: `${{ needs.validate.outputs.release_tag }}`\nRelease workflow: <${{ github.event.workflow_run.html_url }}|View release run>\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View validation>"

  trigger-rollback:
    name: Trigger Rollback
    needs: validate
    if: needs.validate.outputs.validation_passed == 'false'
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.III_CI_APP_ID }}
          private-key: ${{ secrets.III_CI_APP_PRIVATE_KEY }}

      - name: Trigger rollback workflow
        env:
          RELEASE_TAG: ${{ needs.validate.outputs.release_tag }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          echo "::warning::Validation failed - triggering rollback for $RELEASE_TAG"
          gh workflow run rollback.yml \
            --repo "$GH_REPO" \
            -f version="$RELEASE_TAG" \
            -f delete_release=true \
            -f reason="Automated rollback: release validation failed"
