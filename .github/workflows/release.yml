name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}
          owner: MotiaDev
          permission-contents: write

      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          token: ${{ steps.generate_token.outputs.token }}
          draft: false
          prerelease: false
          generate_release_notes: true

  build-frontend:
    name: Build Frontend
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10

      - name: Cache pnpm store
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/share/pnpm/store
          key: pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: pnpm-store-

      - name: Install dependencies
        run: pnpm install --filter console-frontend --frozen-lockfile

      - name: Build frontend for binary embedding
        run: pnpm run build:binary

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: frontend-dist
          path: packages/console-frontend/dist-binary/
          retention-days: 1

  build-release:
    name: Build Release Binaries
    needs: [create-release, build-frontend]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    env:
      SKIP_FRONTEND_BUILD: "1"
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-15-intel
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}
          owner: MotiaDev
          permission-contents: write

      - name: Checkout iii-console
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          token: ${{ steps.generate_token.outputs.token }}
          persist-credentials: false

      - name: Checkout iii SDK
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: iii-hq/sdk
          token: ${{ steps.generate_token.outputs.token }}
          ref: main  # Tracks latest SDK; pin to tag for reproducible releases
          path: _sdk
          sparse-checkout: packages/rust/iii
          sparse-checkout-cone-mode: false
          persist-credentials: false

      - name: Setup SDK path
        run: |
          mkdir -p ../sdk/packages/rust
          cp -r _sdk/packages/rust/iii ../sdk/packages/rust/iii
          ls ../sdk/packages/rust/iii/Cargo.toml
          rm -rf _sdk

      - name: Download frontend artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: frontend-dist
          path: packages/console-rust/assets/

      - name: Install cross-compilation tools
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          case "${{ matrix.target }}" in
            x86_64-unknown-linux-musl)
              sudo apt-get install -y musl-tools
              ;;
            aarch64-unknown-linux-gnu)
              sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
              ;;
          esac

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          key: ${{ matrix.target }}-${{ hashFiles('packages/console-rust/Cargo.lock') }}
          workspaces: packages/console-rust

      - name: Build and upload binary
        uses: taiki-e/upload-rust-binary-action@f391289bcff6a7f36b6301c0a74199657bbb4561 # v1
        with:
          bin: iii-console
          target: ${{ matrix.target }}
          tar: unix
          checksum: sha256
          manifest-path: packages/console-rust/Cargo.toml
          token: ${{ steps.generate_token.outputs.token }}
